---
import Layout from '../../../../layouts/Layout.astro';
import Editor from '../../../../components/Editor.astro';
import { db, Config, Content } from 'astro:db';

const config = await db.select().from(Config);
const site = config[0];

export async function getStaticPaths() {
  const contents = await db.select().from(Content);
  return contents.map(({ id, alias, title, body }) => {
    return {
      params: { id },
      props: { alias, title, body, id },
    };
  });
}

const { alias, title, body, id } = Astro.props;

---
<Layout title={'Edit ' + title + ' | ' + site.name }>
    <div class="wrapper">
        <a href="/admin/content">Back to admin content</a>
        <h1>Edit {title} ({id}) <button class="save">Save</button></h1>
        <label for="title">Title:</label> <input type="text" value={title} id="title">
        <label for="alias">Alias:</label> <input type="text" value={alias} id="alias">
        <Editor body={body} />
        <button class="save">Save</button>
    </div>
</Layout>
<link rel="stylesheet" href="/styles/global.css" />
<link rel="stylesheet" href="/styles/admin.css" />
<script is:inline define:vars={{ id }}>
  
  //console.log(id)

  const buttons = document.querySelectorAll('button.save');

  buttons.forEach((button) => {
    button.addEventListener('click', async () => {
      //console.log('save',window.editor.getData())
      const jsonData = {
        data: {
          alias: document.getElementById('alias').value,
          title: document.getElementById('title').value,
          body: document.getElementById('host').shadowRoot.getElementById('editor').innerHTML
        }
      }
      const response = await fetch("/admin/api/contents/"+id+".json",
      {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(jsonData)
      }).then(()=>{
        window.location.reload(true)
      });

    
    //console.log('json response',response);

    });
  });

</script>