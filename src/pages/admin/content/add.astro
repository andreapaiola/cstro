---
import Layout from '../../../layouts/Layout.astro';
import Editor from '../../../components/Editor.astro';
import { db, eq, Config, Author, Content } from 'astro:db';

const config = await db.select().from(Config);
const site = config[0];

const authors = await db.select().from(Author);

export const prerender = false;

---
<Layout title={'Add Content to' + ' ' + site.name }>
    <div class="wrapper" style="padding: 2rem 0;">
      <a href="/admin/content">Back to Admin Content</a>
      <h1>Add Content to {site.name}
        <button class="save">Save</button>
      </h1>
      <label for="published">Published: </label><input type="checkbox" name="published" id="published" checked />
        <label for="title">Title:</label> <input type="text" value="" id="title">
        <label for="alias">Alias:</label> <input type="text" value="" id="alias">
        <label for="author">Author:</label>
        <select name="author" id="author">
          {authors.map((item) => (
            <option value={item.id}>{item.name}</option>
          ))}
        </select>
    </div>
    <Editor body="" />
    <div class="wrapper" style="padding: 2rem 0;">
      <button class="save">Save</button>
  </div>
</Layout>

<link rel="stylesheet" href="/styles/global.css" />
<link rel="stylesheet" href="/styles/admin.css" />

<script is:inline>
const addButtons = document.querySelectorAll('button.save');

addButtons.forEach((button) => {
  button.addEventListener('click', async () => {
    //console.log('save',window.editor.getData())
    const jsonData = {
      data: {
        authorId: document.getElementById('author').value,
        alias: document.getElementById('alias').value,
        title: document.getElementById('title').value,
        body: document.getElementById('host').shadowRoot.getElementById('editor').innerHTML,
        published: document.getElementById('published').checked,
      }
    }
    const response = await fetch("/admin/api/contents/add.json",
    {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(jsonData)
    }).then(()=>{
      window.location.reload(true)
    });
  //console.log('json response',response);

  });
});
</script>